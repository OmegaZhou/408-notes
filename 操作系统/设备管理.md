# 设备管理

## 设备的分类

### 按设备的使用特性

* 存储设备
  * 磁盘
  * 磁带
* 人机交互设备（输入输出设备）
  * 输入设备
    * 键盘
  * 输出设备
    * 显示器
    * 打印机
* 网络通信设备
  * 网络接口
  * 调制解调器

### 按信息交换单位分类

* 字符设备
  * 键盘
  * 打印机
  * 显示器
* 块设备
  * 磁盘

### 按传输速率分类

* 低速设备
  * 键盘
  * 鼠标
* 中速设备
  * 打印机
* 高速设备
  * 磁带机
  * 磁盘

### 按设备共享属性

* 独占设备
  * 打印机
* 共享设备
  * 磁盘
* 虚拟设备

## 设备管理的功能

* 设备分配
* 设备处理
* 缓冲管理
* 设备独立性

## I/O控制方式

### 程序直接控制方式

* 程序需要输入/输出数据时，处理器不断轮询检查状态寄存器的值，当状态寄存器就绪时取出/存入相应数据
* 然后重复上述循环，直至所有数据都输入/输出完成
* 优点
  * 简单
* 缺点
  * CPU利用率非常低，绝大部分时间在测试设备状态

### 中断控制方式

* 输入/输出数据时，CPU向设备控制器发出一个启动指令
* 设备完成相应功能后，发出中断信号，CPU收到中断信号后，再转向中断处理程序，继续处理后续步骤
* 优点
  * 设备和CPU可以并行运行，提高了CPU的利用率
* 缺点
  * 每输入/输出一个数据，就要发出一个中断请求，耗费CPU时间

### DMA方式（直接存储器存取）

* 特点
  * 基本单位是数据块
  * 数据直接从设备送入内存或从内存直接送入设备
  * 仅在传输一个或多个数据块的开始和结束时，才需要CPU干预（发出中断请求），传送是在CPU控制器的控制下完成的
* 需要输入/输出数据时，CPU将数据内存起始地址和字节数发给DMA控制器的内存地址寄存器和传送字节计数器中
* DMA使用周期挪用的方式传送数据
  * 设备访存时，CPU不访存，设备于CPU不冲突
  * 设备访存时，CPU正在访存，设备等待CPU访存结束后访存
  * 设备和CPU同时访存时，设备访存优先级高于CPU，先窃取一二个存取周期，之后CPU再访存
* DMA控制器的寄存器
  * 命令/状态寄存器（CR）：接收CPU发来的命令或有关控制信息
  * 内存地址寄存器（MAR）：待发送/待接收数据的内存起始地址
  * 数据寄存器（DR）：暂存待发送/接收的数据
  * 数据计数器（DC）：本次要传输的字节数
* 优点
  * 设备和CPU可以并行，数据交换速度加快，且不需要CPU干预
* 缺点
  * 数据传输方向，数据内存起始地址和数据长度都由CPU控制，每个设备都需要一个DMA控制器，设备增加时，DMA控制器的使用不经济

### 通道控制方式

* I/O通道是一个专门负责输入输出的处理机

* 通道处理机执行指令单一，与CPU共享内存

* CPU要进行数据传输时，给通道处理器发出一条I/O指令，并给出通道程序首地址和访问的设备，通道处理机便可自行完成该I/O任务，在数据传输完成后在发送中断请求

* 与DMA的区别

  * 通道方式中，每次传输的数据块大小，数据内存地址都是由通道自行决定
  * 每个DMA控制器对应一个设备，每个通道处理器可以对应多个设备

* 类型

  * 字节多路通道
    * 适合低速、中速设备
    * 以字节交叉的方式轮流向多个设备服务
  * 数组选择通道
    * 适合高速设备
    * 同一时间内只能执行一个通道程序，被一个设备独占
    * 利用率低
  * 数组多路通道
    * 结合字节多路通道和数组选择通道的优点
    * 以数组方式传输数据

## I/O软件结构层次

1. 用户层I/O软件
   * 实现与用户交互的接口
   * 大部分在操作系统内部
   * 少部分为用户层（包括库函数、运行于内核之外的程序），必须通过调用系统调用获取相应服务
2. 设备独立性软件
   * 实现用户程序和设备驱动器的统一接口、设备命令、设备保护和设备分配与释放等
   * 使用逻辑设备名来使用某设备
   * 系统实际执行时，将其映射为物理设备
   * 逻辑设备名优点
     * 增加设备分配灵活性
     * 易于实现I/O设备重定向
   * 功能
     * 执行所有设备的公用操作
     * 向用户层提供统一接口
3. 设备驱动程序
   * 与硬件直接相关，负责具体实现系统对设备发出的操作指令，驱动I/O设备故障的驱动程序
   * 每类设备设置一个设备驱动程序
4. 中断处理程序
   * 唤醒被阻塞的驱动程序进程
   * 保护被中断进程的CPU环境
   * 进行中断处理
   * 恢复现场
5. 硬件设备
   * 电子部件（设备控制器/适配器）
     * 功能
       * 接收和识别CPU或通道发来的命令
       * 实现数据交换
       * 发现和记录设备自身信息
       * 设备地址识别
     * 组成
       * 设备控制器与CPU的接口（数据线，地址线（与数据寄存器，控制/状态寄存器相连），控制线）
       * 设备控制器与设备的接口（每个接口都要数据，控制和状态三种类型的信号）
       * I/O控制逻辑
   * 机械部件（硬件本身）

## I/O核心子系统

### 服务

* I/O调度
* 缓冲与高速缓存
* 设备分配与回收
* 假脱机
* 设备保护和差错处理

### I/O调度

* 通过调度I/O请求顺序改善效率
* 磁盘调度就属于I/O调度的一种

### 缓冲与高速缓存

#### 磁盘高速缓存

* 逻辑上属于磁盘，物理上属于内存
* 实现方式
  * 专门开辟一个内存空间作为磁盘高速缓存
  * 把未利用的内存空间作为一个缓冲池，供请求分页系统和磁盘I/O共享

#### 缓冲区

* 目的
  * 缓和CPU与I/O设备速度不匹配的矛盾
  * 减少CPU中断频率
  * 解决基本数据单元大小不匹配
  * 提高CPU与设备之间的并行性
* 实现
  * 采用硬件缓冲器（成本太高，只在少数关键部位使用）
  * 采用缓冲区（位于内存）
* 特点
  * 不能同时输入和输出，必须串行操作
* 分类
  * 单缓冲：相对于处理器和设备是串行的
    1. 先将数据装入缓冲区
    2. 再取走数据
  * 双缓冲：由两个缓冲区组成
    1. 填完第一个缓冲区后，填写第二个缓冲区
    2. 在填写第二个缓冲区时，可以从第一个缓冲区提取数据
  * 循环缓冲：增加多个缓冲区形成循环链表，其余步骤与双缓冲一致，双缓冲可视为缓冲区链表长度为2的循环缓冲
  * 缓冲池
    * 三个队列
      * 空缓冲队列
      * 装满输入数据的缓冲队列（输入队列）
      * 装满输出数据的缓冲队列（输出队列）
    * 工作缓冲区
      * 收容输入数据的工作缓冲区
      * 提取输入数据的工作缓冲区
      * 收容输出数据的工作缓冲区
      * 提取输出队列的工作缓冲区
    * 流程
      1. 需要输入/输出数据时，从空缓冲队列取下一个作为收容输入/输出数据的工作缓冲区
      2. 装满后放入输入/输出队列末尾
      3. 将输入/输出队列头部缓冲区作为提取输入/输出数据的工作缓冲区
      4. 处理器/设备从提取输入/输出数据的工作缓冲区中获取输入/输出的数据
      5. 提取输入/输出数据的工作缓冲区空了以后，将其放入空缓冲队列

### 设备分配与回收

#### 使用方式

* 独占式使用设备
* 分时式共享使用设备
* 以SPOOLing方式使用外部设备

#### 设备分配的数据结构

* 设备控制表（DCT）：一个DCT代表一个设备，存放设备的各种属性
* 控制器控制表（COCT）：用于解析命令，一个DCT具有一个指向COCT的表项
* 通道控制表（CHCT）：反应通道状态，一个COCT对应一个CHCT，一个CHCT对应多个设备
* 系统设备表（SDT）：一个系统只有一个，存放系统中所有设备的情况

#### 设备分配策略

##### 原则

* 充分发挥设备的使用效率
* 避免死锁
* 使用户程序和具体设备隔离开

##### 分配方式

* 静态分配：一次性将作业需要的所有设备分配出去，不会死锁，但效率低
* 动态分配：进程运行时提出请求获取设备，效率高，肯会死锁

##### 分配算法

* 先请求先分配
* 优先级高者优先

#### 设备分配安全性

* 安全分配方式：进程发出I/O请求后阻塞，完成后才唤醒，此时不请求和保持任何资源
  * 优点
    * 设备分配安全
  * 缺点
    * 同一进程下，CPU和设备是串行工作的
* 不安全分配方式：发出I/O请求时继续运行，需要时继续发出新I/O请求，直至请求设备被占用时堵塞
  * 优点
    * 一个进程可同时操作多个设备
  * 缺点
    * 可能产生死锁

#### 设备独立性

* 在系统中设置一个逻辑设备表（LUT），将逻辑设备名银蛇为物理设备名

* LUT组成

  * 逻辑设备名
  * 物理设备名
  * 设备驱动程序入口地址

* 建立方式

  * 一个系统只有一张，不允许逻辑设备名重名，适合单用户系统
  * 每个用户设置一张LUT，用户登录时，建立进程，将LUT放入该进程PCB中

#### SPOOLing技术（假脱机技术）

* 将独占设备改造为共享设备
* 输入井和输出井
  * 在磁盘中开辟的两个区域，模拟脱机输入/输出时的磁盘
* 输入/输出缓冲区
  * 在内存中开辟的两个区域，暂存输入/输出的数据

* 输入流程
  * 数据先从缓冲区输入输入井
  * 再从输入井读入内存
* 输出流程
  * 数据先从缓冲区输入输出井
  * 再从输出井输出到设备
* 作用
  * 作为中转站，在设备繁忙时作为虚拟设备暂存数据，避免进程运行停滞




## 其他零散知识

* 缓存（cache）与缓冲（buffer）的区别
  1. **Buffer**（缓冲区）是系统两端处理**速度平衡**（从长时间尺度上看）时使用的。它的引入是为了减小短期内突发I/O的影响，起到**流量整形**的作用。比如生产者——消费者问题，他们产生和消耗资源的速度大体接近，加一个buffer可以抵消掉资源刚产生/消耗时的突然变化。
  2. **Cache**（缓存）则是系统两端处理**速度不匹配**时的一种**折衷策略**。因为CPU和memory之间的速度差异越来越大，所以人们充分利用数据的局部性（locality）特征，通过使用存储系统分级（memory hierarchy）的策略来减小这种差异带来的影响。
  3. 假定以后存储器访问变得跟CPU做计算一样快，cache就可以消失，但是buffer依然存在。比如从网络上下载东西，瞬时速率可能会有较大变化，但从长期来看却是稳定的，这样就能通过引入一个buffer使得OS接收数据的速率更稳定，进一步减少对磁盘的伤害。
  4. TLB（Translation Lookaside Buffer，翻译后备缓冲器）名字起错了，其实它是一个cache.

* 脱机输入/输出
  * 利用专门的外围控制机，将低速I/O设备上的数据传送到高速磁盘上，或者相反