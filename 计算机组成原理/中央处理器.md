# 中央处理器

## 功能和结构

### 功能

* CPU=运算器+控制器
* 运算器
  * 对数据进行加工
* 控制器
  * 协调控制各部件指令序列
    * 取指令
    * 分析指令
    * 执行指令
  * 控制程序的输入
  * 控制运算结果的输出
  * 对总线的管理
  * 中断处理
* 总结
  * 指令控制
  * 操作控制
  * 时间控制
  * 数据加工
  * 中断处理

### 结构

* 控制器
  * 程序计数器PC
  * 指令寄存器IR
  * 指令译码器
  * 存储器地址寄存器
  * 存储器数据寄存器
  * 时序系统
  * 微操作信号发生器
* 运算器
  * 算术逻辑单元ALU
  * 暂存寄存器
  * 累加寄存器
  * 通用寄存器组
  * 程序状态字寄存器
  * 移位器
  * 计数器：控制乘除运算的操作步骤
* 中断系统
* 寄存器
  * 小快贵

## 主要寄存器

### 运算器中的寄存器

* 暂存寄存器
  * 暂存从主存读来的数据
  * 对程序员透明
* 累加寄存器（ACC）
  * 暂时存放ALU的运算结果
* 通用寄存器组
* 状态条件寄存器
  * 存放算术指令和逻辑指令运行或测试的结果，使用一位触发器
  * 还可以保存中断和系统工作状态信息

### 控制器中的寄存器

* 程序计数器PC
* 指令寄存器IR
* 存储器数据寄存器MDR
  * 作为CPU，内存和外部设备之间信息传送的中转站
  * 补偿CPU，内存和外部设备之间再操作速度上的差别
  * 在单累加器的运算器中，可兼做操作数寄存器
* 存储器地址寄存器MAR

## 指令执行过程

### 指令周期

* 指令周期包含若干**机器周期**，为执行一条指令所花的时间
* 不同指令的指令周期可能不同
* 一个机器周期包括若干个**时钟周期**
* 不同的机器周期时间可能不同
* 指令周期=取指周期+间址周期+执行周期+中断周期

### 指令执行方案

* 单指令周期
  * 所有指令采用相同的执行时间
  * 运行效率低
* 多指令周期
  * 不同指令选用不同步骤，指令周期可以不同
* 流水线方案

### 指令周期的数据流

#### 取指周期

1. (PC)->MAR//发送指令地址至MAR
2. 1->R//发出读命令
3. M(MAR)->MDR//取出指令地址
4. (MDR)->IR
5. OP(IR)->CU
6. PC+1->PC

#### 间址周期

1. AD(IR)->MAR
2. 1->R
3. M(MAR)->MDR

#### 执行周期

* ，没有固定格式

#### 中断周期



## 数据通路功能和基本结构

### 数据通路的功能

* 实现CPU内部运算器和寄存器，寄存器间的数据交换

### 数据通路基本结构

* CPU内部总线方式
  * 使用单总线/双总线/多总线连接所有寄存器
  * 使用双总线或多总线时，数据传递可以同时进行
  * 结构简单
  * 数据传输较多时可能会出现冲突，性能较低
* 专用数据通路方式
  * 根据指令执行过程的数据流动安排线路
  * 避免使用共享的总线
  * 性能较高
  * 硬件量较大

### 常见数据通路数据传输

#### 寄存器之间

1. R1->Bus      //R1out有效
2. Bus->R2      //R2in有效

#### 主存与CPU之间

1. R1->Bus->MAR       //R1out,MARin有效
2. 1->R
3. M(MAR)->MAR       //MDRin有效
4. MDR->Bus->R2      //MDRou，R2in有效

#### 执行算术运算或逻辑运算

1. Ad(IR)->Bus->MAR
2. 1->R
3. M(MAR)->MDR
4. MDR->Bus->R1
5. (ACC)OP(R1)->R2(暂存器)
6. R2->ACC

## 控制器功能和工作原理

### 硬布线控制器



#### 微操作命令示例

##### 执行周期

###### 加法指令

* 前提：一个操作数在累加器，一个在主存A单元，结果存入累加器
* 步骤
  1. Ad(IR)->MAR
  2. 1->R
  3. M(MAR)->MDR
  4. (ACC)+(MDR)->ACC

###### 存数指令

* 前提：将上述累加器结果存入地址单元A
* 步骤
  1. Ad(IR)->MAR
  2. 1->W
  3. (ACC)->MDR
  4. (MDR)->M(MAR)

##### 中断周期

###### 断点存储在主存

* 前提：假设断点保存至主存的0单元，采用硬件向量寻找中断地址
* 步骤
  1. 0->MAR
  2. 1->W
  3. (PC)->MDR
  4. (MDR)->M(MAR)
  5. 向量地址->PC
  6. 0->EINT              //关中断

###### 断点存储在堆栈

* 前提：假设断点保存至主存的0单元，采用硬件向量寻找中断地址
* 步骤
  1. (SP)-1->SP
  2. (SP)->MAR
  3. 1->W
  4. (PC)->MDR
  5. (MDR)->M(MAR)
  6. 向量地址->PC
  7. 0->EINT              //关中断

#### 控制单元的输入

1. 操作码
   * 来源：指令寄存器
   * 功能：将操作码送入控制单元CU进行译码
2. 标志
   * 来源：上条指令的结果产生的信号（如进位信号）
   * 功能：参与本条指令的执行
3. 时钟
   * 来源：时钟脉冲
   * 功能：控制操作时间，操作时序，执行方式
4. 控制信号
   * 来源：控制总线
   * 功能：根据不同信号执行不同功能（如中断请求，DMA请求）

#### 控制单元的输出

1. CPU的控制信号
   * 功能：控制寄存器间数据的传输和ALU的不同操作
2. 送至系统总线的控制信号
   * 功能：命令主存读写、中断响应等

#### CPU控制方式

* 同步控制方式
  * 特点
    * 任何微操作或指令的执行都由事先确定且有统一基准时标的时序信号控制
    * 以最长的微操作序列和最繁琐的微操作为标准，采用完全统一、具有相同时间间隔和相同数目的节拍作为机器周期（**定长方式**的同步控制）
    * 每个机器周期节拍数可以不同（**不定长方式**的同步控制）
    * 大部分指令采用同样节拍的机器周期内完成，少部分复杂指令在完成公共节拍后，转由局部控制器完成剩余节拍，完成后再转回重要控制器（**中央控制和局部控制相结合**的同步控制）
  * 优点
    * 电路简单
  * 缺点
    * 运行速度慢
* 异步控制方式
  * 特点
    * 各部件工作速度不一致
    * 采用应答的方式进行联络
  * 优点
    * 运行速度快
  * 缺点
    * 电路复杂
  * 用途
    * 主机和I/O设备间的传输控制
* 联合控制方式
  * 特点
    * 同步和异步方式的折中
    * 大部分微操作使用同步控制
    * 少部分使用异步控制

### 微程序控制器

#### 名词概念

* 微操作
  * 计算机中最基本的不可分解的操作
  * 构成机器指令的最小单位
* 微命令
  * 控制部件向执行部件发出的控制命令
  * 控制序列的最小单位
  * 与微操作一一对应
  * 可分为**互斥微命令**和**相容微命令**
* 微指令
  * 若干微命令的集合
  * 存放微指令控制存储器称为微地址
  * 基本构成
    * 操作控制字段（操作码字段）：产生各种操作控制信号
    * 顺序控制字段（微地址码字段）：控制产生下一条要执行的微指令地址
* 微周期
  * 读取一条微指令并执行响应微操作所需的时间
* 主存储器
  * 在CPU外部，用RAM实现，存放程序和数据
* 控制存储器
  * 存放微程序，在CPU内部，用ROM实现

#### 组成

* 控制存储器
* 微指令寄存器
* 微地址形成部件
* 微地址寄存器

#### 步骤

1. 机器开始运行时将**取指微程序**入口地址送入CMAR，并从CM中读出相应微指令送人CMDR，使用**取指微程序**将机器指令存入指令寄存器中
2. 将机器指令的操作码字段使用微地址形成部件产生该指令所对应的微程序的入口地址，并送人CMAR
3. 从CM中逐条取出对应的微指令并执行
4. 执行完一个机器指令的微程序后，继续第一步

#### 微指令编码方式

##### 直接编码

* 每个字段代表一个微命令
* n个微命令至少需要n位操作字段
* 优点
  * 简单、直观、执行快
  * 并行性好
* 缺点
  * 指令字过长

##### 字段直接编码

* 将互斥性微命令分在同一字段内，相容性微命令分在不同段内
* 每个小段的信息位不能过多，防止译码线路过于复杂，译码时间长
* 每个小端留出一个状态表示不发出任何微命令

##### 字段间接编码

* 某个字段的微命令由另一个字段的微命令来解释
* 缩短的指令字长
* 削弱的并行能力

#### 微指令地址的形成

* 直接由微指令的下地址字段给出（断定方式）
* 后续微指令的地址根据机器指令操作码形成
* 增量计数法：微指令地址连续，和PC一样自增找到下一只了地址
* 分支转移：根据标志位决定下一地址
  * 格式：操作控制字段+转移条件+转移地址
* 由硬件产生微指令地址

#### 微指令格式

| 项目                   | 水平型微指令               | 垂直型微指令               |
| ---------------------- | -------------------------- | -------------------------- |
| 并行性                 | 高                         | 差                         |
| 执行指令所需的微指令数 | 少                         | 多                         |
| 与机器指令的相似度     | 高                         | 低                         |
| 总结                   | 微指令结构长，微程序结构短 | 微指令结构短，微程序结构长 |

### 硬布线和微程序控制器对比

#### 硬布线

* 优点
  * 速度快
* 缺点
  * 设计完成后难以修改

#### 微程序

* 优点
  * 规整性
  * 灵活性
  * 可维护性
* 缺点
  * 速度慢

#### 对比

|          | 硬布线控制器                     | 微程序控制器                                 |
| -------- | -------------------------------- | -------------------------------------------- |
| 工作原理 | 微操作控制信号由组合逻辑电路产生 | 微操作控制信号以微程序的形式存放于控制存储器 |
| 执行速度 | 快                               | 慢                                           |
| 规整性   | 不规整                           | 较规整                                       |
| 应用场景 | RISC                             | CISC                                         |
| 易扩充性 | 差                               | 好                                           |



## 指令流水线

### 分类

#### 按使用级别

* 部件功能级
  * 将复杂的算术逻辑运算组成流水线操作
  * 例：将浮点数加法分解成求阶差、对阶、尾数相加和结果规则化四个子过程
* 处理机流水线
  * 将一条指令的解释过程制成流水线
  * 例：将指令分成取指、译码、执行、访存、写回四个部分
* 处理机间流水线
  * 每个处理机完成一个专门任务，结果交予下一个处理机
  * 例：Map Reduce

#### 按完成的功能

* 单功能流水线
  * 只实现固定功能
* 多功能流水线
  * 将各流水线部件进行不同组合完成不同功能

#### 按连接方式

* 静态流水线
  * 在同一时间内各段执行同一功能的子过程
* 动态流水线
  * 在同一时间内，某一功能的部分流水线段可同时作为其他功能的流水线段

#### 按功能段间是否有反馈

* 线性流水线
  * 流水线部件不存在回路
* 非线性流水线
  * 存在回路
  * 适合递归运算

### 影响流水线性能的因素

* 数据冲突（数据冒险）
  * 出现读写冲突
  * 解决方案
    * 阻塞冲突操作
      * 硬件阻塞（stall）
      * 软件阻塞（使用nop指令）
    * 设置专用通路：直接将前一指令的计算结果直接从ALU送入数据输入寄存器中
    * 编译优化
* 控制冲突（控制冒险）
  * 出现转移指令
  * 解决方案
    * 分支预测
      * 静态分支预测：只预测一种结果
      * 动态分支预测：根据指令执行的历史情况动态调整预测结果
    * 同时预取两个控制流的目标指令
    * 加快和提前形成条件码
    * 提高转移方向的预测率

#### 流水线性能指标

* 吞吐率：单位时间完成的任务数量
  $$
  设任务数为n，流水线段数为k，每段花费t时间\\
  吞吐率TP=\frac{n}{(k+n-1)t}\\
  理想情况下，最大吞吐率TP_{max}=\lim_{n \to \infty}TP=\frac{1}{t}
  $$
  

* 加速比：不使用流水线的执行时间与使用流水线后的执行时间比
  $$
  T_0为不使用流水线的时间，T_k为使用流水线的时间\\
  加速比S=\frac{k*n*t}{(k+n-1)t}=\frac{k*n}{k+n-1}\\
  最大加速比S_{max}=\lim_{n \to \infty}S=k
  $$

* 流水线效率
  $$
  效率E=\frac{n个任务占用的时空图有效面积}{n个任务占用的时空图总面积}
  $$

### 超标量流水线

#### 超标量流水线技术

* 增加多个部件，并行执行多条指令

#### 超流水线技术

* 划分更细小的流水线段

#### 超长指令字

* 将多条能并行的指令组合形成一个超长指令字
* 需要多个处理部件