# 存储器的组成结构

## 存储系统的组成

* 主存储器
* 高速缓冲存储器（Cache）
* 辅助存储器

## 存储器的分类

### 按存储介质分类

* 半导体存储器
  * 随机存储器
  * 只读存储器
* 磁表面存储器
  * 磁盘
  * 磁带
* 磁心存储器：由各种磁心制成，现已被半导体存储器取代
* 光盘存储器（光存储器）
  * 光盘

### 按存取方式分类

* 随机存取存储器（RAM）
  * 优点
    * 读写方便
    * 使用灵活
    * 存取时间和存储位置无关
  * 缺点
    * 断电信息丢失
  * 分类
    * 静态RAM（SRAM）：用于制作Cache
    * 动态RAM（DRAM）：用于制作主存
* 只读存储器
  * 特点
    * 也是随机存取
    * 断电可保留
    * 只能读入不能写入
  * 分类
    * 掩膜型ROM（MROM）
    * 可编程ROM（PROM）
    * 可擦除可编程ROM（EPROM）
    * 电可擦除可编程ROM（EEPROM）
    * 快擦除读写存储器/闪存（Flash Memory）
  * 缩写中有E的ROM是可擦除的
  * 一般用于存放不变的程序
  * ROM+RAM=主存
* 串行访问存储器
  * 特点
    * 读写操作时需要按照物理位置的先后顺序访问
  * 分类
    * 顺序存取存储器
      * 磁带
    * 直接存取存储器
      * 磁盘：半串行，寻道随机访问，之后串行访问

### 按在计算机的作用分类

* 主存
* 辅存
* 缓冲存储器（Cache）

### 按信息的可保存性分类

* 易失存储器
  * RAM
* 非易失存储器
  * ROM
  * 磁表面存储器
  * 光存储器

## 存储器性能指标

* 存储容量
* 单位成本
* 存储速度
  * 存取时间：启动一次存储器到完成该操作所需的时间
  * 存取周期：连续两次独立访问存储器所需的时间间隔，通常大于存取时间
  * 主存带宽

## 存储器层次化结构

1. 寄存器（CPU，主机）
2. 缓冲（CPU，主机）
3. 主存（主机）
4. 磁盘（辅存）
5. 光盘（辅存）
6. 磁带（辅存）

## 半导体随机存储器

### 基本结构

#### 组成

* 存储矩阵
* 译码驱动电路
* 读/写电路
* 数据线（双向）
* 控制线（单向）
  * 读/写控制线
  * 片选线：选择存储芯片

#### 译码方式

##### 片选法

* 使用地址线选取矩阵的某一行
* 每一根地址线代表一个二进制位
* n根地址线可表示0~2^n^-1行

##### 重合法（双译码）

* 在片选法的基础上，以同样的方式选取行上的某一列

### SRAM

* 使用双稳态触发器（六晶体管MOS）

* 不需要再生（非破坏性读出）
* 优点
  * 存取速度快
* 缺点
  * 集成度低
  * 功耗大

### DRAM

* 存储电路分类
  * 多管型
  * 单管型
* 工作原理：使用电容存储电荷
* 采用地址复用技术，地址线是原有的1/2，地址信号分行、列两次传送
* 优点
  * 易集成
  * 位价低
  * 容量大
  * 功耗低
* 易失性存储器，电荷只能维持1~2ms，需要定期刷新，两次刷新间隔称为**刷新周期**
* 刷新一行默认需要一个存取周期
* 刷新方式
  * 集中刷新：一个刷新周期内，使用固定一段时间进行逐行刷新，该段时间称为**死时间**
    * 存取速度高
    * 集中刷新期间无法访问存储器
  * 分散刷新：将系统工作周期分为两部分，前一部分正常读写，后一部分进行刷新某一行
    * 增加了存取周期，降低系统速度
    * 没有死时间
  * 异步刷新：刷新周期/行数，得到时间t，每隔时间t刷新一次
    * 避免CPU等待过长
    * 减少刷新次数
    * 提高工作效率

### 读写周期与读写时间

* 读写周期为芯片连续两次操作的最小时间间隔
* 读写时间为芯片进行一次操作的时间
* 读写周期大于读写时间

## 只读存储器

* 掩膜型ROM（MROM）
  * 制造时写入内容，只能读不能写
  * 通过元件的有无表示01
* 可编程ROM（PROM）
  * 使用熔丝存储数据
  * 用户可以自行填入编程
  * 但只可填入一次
* 可擦除可编程ROM（EPROM）
  * 使用悬浮栅存储数据
  * 使用高压写入数据
  * 能使用紫外线擦除全部内容（不能部分擦除）
* 电可擦除可编程ROM（EEPROM）
  * 使用悬浮栅存储数据
  * 使用高压写入数据
  * 使用高压擦除数据（可全部擦除，也可部分擦除）
* 快擦除读写存储器/闪存（Flash Memory）
  * 按块存取数据
  * 非易失性
  * 结合了ROM和RAM的优点
* 固体硬盘（SSD）
  * 组成：控制单元+Flash芯片
  * 保留了闪存的腾讯
  * 读写速度快，功耗低
  * 造价高

## 主存储器与CPU连接

### 存储芯片信号

* CS：片选信号，低电平有效，用于选择芯片
* WE：读/写信号

### 容量格式

* a*b：
  * a为地址，连接地址线
  * b为数据位数，连接数据线

### 容量扩充

#### 位扩充

* 扩充数据线
* 通过增加数据线

#### 字扩充

* 扩充地址线
* 使用片选信号选择存储芯片

#### 字位扩充

* 结合上述二者方式

## 双端口RAM

* 拥有左右两个独立端口，使用两组独立的地址线、数据线、读写控制线
* 提高并行性
* 冲突（读写冲突，写冲突）解决：使用一个BUSY信号，当会发生冲突时，暂时关闭一个端口

## 多模块存储器

### 单体并行存储器

* 每个存储单元存储m个字，数据字宽也为m
* 一次可并行读出m个字
* 优点
  * 提高存储器带宽
  * 增加存储器工作效率
* 缺点
  * 对于不连续的指令和数据，效果不明显

### 多体并行存储器

* 使用多个存储模块构成

#### 高位交叉编址

* 高地址部分代表存储器编号
* 模块内地址连续，仍为顺序存储器
* 缺点
  * 访问连续内存块时，总时只访问一个层次模块，不能提高吞吐率

#### 低位交叉编址

* 低地址部分代表存储器编号

* 数据连续存放在相邻模块，为交叉存储器

* 采用流水线方式存取

* 存取时间计算
  $$
  设一个模块内一个字存取周期为T，总线传送周期为r\\
  存储器模块数应大于等于\frac Tr，从而保证流水线读取完所有模块后能直接进行下一轮读取\\
  这样连续存取m个字所需的时间t=T+(m-1)r
  $$

## 高速缓冲存储器（Cache）

### 局部性原理

* 时间局部性：某个数据或指令可能在短时间内多次使用
* 空间局部性：某个数据或指令使用后，附近的数据或指令可能在短时间内也被使用

### 组成

* 地址映射变换机构：将主存地址转换为Cache地址
* 替换机构：实现Cache块替换

### 工作原理

* 将Cache和主存划分成相等的块

* Cache块又称**Cache行**

* 块的长度称为块长（Cache行长）

* 工作流程

  1. CPU发出访问请求
  2. 若Cache命中，直接访问Cache
  3. 若Cache不命中，若Cache已满，选择替换的Cache块，反之选择一个空闲块
  4. 访问主存找到相应的块，同时装入Cache和传送给CPU

* 部分计算机在访问Cache的同时也会访问主存，当Cache命中时终止主存访问

* Cache与CPU数据交换单位为**字**

* Cache与主存数据交换单位为**块**

* $$
  Cache命中率H=\frac{Cache总命中次数}{Cache总命中次数+访问主存的总次数}
  $$

  

* $$
  设Cache命中率为H，访问Cache时间为T_c，访问主存时间为T_m\\
  平均访问时间T_a=H*T_c+(1-H)*T_m
  $$

### Cache映射方式

#### 直接映射

* 每个主存块对应一个Cache块

* 映射关系：
  $$
  设j为Cache块号，i为主存块号，Cache总块数为m\\
  j = i\ mod\ m
  $$

* 地址结构：标记+Cache块号+块内地址

* 使用**有效位**标识Cache是否有效

* 不需要替换算法

#### 全相联映射

* 每个主存块可对应任意Cache块
* 优点
  * 冲突概率低
  * 空间利用率高
  * 命中率高
* 缺点
  * 标记字段比较速度慢
  * 成本高
  * 通常使用昂贵的内容寻找方式（相联存储器）
* 地址结构：标记+块内地址

#### 组相联映射

* 将Cache分成若干大小相同的组

* 数据块可装入所属组内任意位置

* 映射关系
  $$
  设j为Cache块号，i为主存块号,Cache组数为Q\\
  j = i\ mod\ Q
  $$

* 地址结构：标记+块号+块内地址

### 替换算法

* 随机算法：
  * 随机替换
  * 命中率较低
* 先进先出算法（FIFO）：
  * 选择最早调入的块替换
  * 容易实现
  * 命中率较低
* 近期最少使用算法（LRU）：
  * 选择近期内最久未被访问过的Cache替换
  * 平均命中率高于FIFO
  * 堆栈类算法
* 最不经常使用算法
  * 选择近期访问次数最少的行替换

### 写策略

#### 写命中

* 全写法
  * CPU写入Cache时，同时把数据写入主存
  * 替换块时直接覆盖即可
  * 优点
    * 实现简单
    * 随时保持贮存数据正确
  * 缺点
    * 增加缓冲次数
  * 写缓冲
    * 增加一个FIFO队列缓冲，缓和写速度不匹配问题
* 写回法
  * Cache被换出时写回内存
  * 使用**标记位（脏位）**判断是否被修改
* 写一次法
  * 第一次写入时写回内存
  * 其余处理方式与写回法一致

#### 写不命中

* 写分配法
  * 加载主存块至Cache中，并修改Cache块
  * 缺点：每次写不命中都要调取一块
  * 一般与写回法合用
* 非写分配法
  * 直接写入内存，不进行掉块
  * 一般与全写法合用

## 虚拟存储器

* 页式虚拟存储器
* 段式虚拟存储器
* 段页式虚拟存储器
* 快表（TLB）
* 详细见**操作系统**

## 外存储器

### 硬盘存储器

#### 数据存储方式

* 归零制（RZ）
  * 记录1时，通**正向电流**
  * 记录0时，通**反向电流**
  * 0，1之间电流归零
* 不归零制（NRZ）
  * 记录1时，通**正向电流**
  * 记录0时，通**反向电流**
  * 电流不归0
* 见1就翻的不归零制（NRZI）
  * 记录1时，电流方向与上一周期相反
  * 记录0时，电流方向不变
  * 电流不归零

#### 性能指标

* 记录密度
  * 延半径长度单位长度的磁道数（即单位长度有多少个同心圆）
  * 相邻磁道之间距离称为**道距**
* 位密度
  * 单位长度磁道记录的二进制信息位数
* 默认条件下，一个磁道存放的信息量相等，即越靠近圆心的磁道位密度越大
* 题目中给出的位密度默认为最内圈磁道位密度

#### 存储容量

* $$
  设C为总存储容量，n为盘面数，k为每个盘面的磁道数，s为每条磁道能记录的二进制代码数\\
  C=nks
  $$

#### 平均寻址时间

* 平均寻址时间=平均寻道时间+平均等待时间

#### 组成

* 磁记录介质
* 磁盘控制器
* 磁盘驱动器

#### 分类

* 磁盘是否可换
  * 可换盘磁盘存储器
  * 固定磁盘存储器
* 磁头工作方式
  * 固定磁头磁盘存储器（每个磁道上有一个磁头，成本高）
  * 移动磁头磁盘存储器

#### 磁盘地址

* 磁盘地址=台号（磁盘组编号，使用多磁盘组成存储器）+磁道号+盘面号+扇区号

### 磁盘阵列

#### RAID 0

* 直接由多块磁盘组成

#### RAID 1

* 镜像备份

#### RAID 2

* 纠错的海明校验码

#### RAID 3

* 位交叉奇偶校验

#### RAID 4

* 块交叉奇偶校验

#### RAID 5

* 无独立校验的奇偶校验

### 光盘存储器

* 使用激光存储（光存储技术）

#### 分类1

* 第一代光存储技术（不支持可擦除重写）
* 第二代光存储技术（支持可擦除重写）

#### 分类2

* 只读型光盘（由厂家写入一次）
  * 被称为CD-ROM，但不属于ROM
* 只写一次型光盘（可由用户写入一次）
* 可擦写光盘