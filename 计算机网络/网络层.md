# 网络层

## 功能

### 异构网络互联

* 使得适用不同标准的网络在网络层中形成一个虚拟互联网络（逻辑互联网络）
* 网络互联使用的中继设备
  * 物理层：中继器，集线器
  * 数据链路层：网桥，交换机
  * 网络层：路由器
  * 网络层以上：网关

### 路由与转发

* 路由选择
* 分组转发

### 拥塞控制

* 开环控制：设计时考虑发生拥塞的因素，做决定时不考虑当前网络状态
* 闭环控制：不考虑发生拥塞的因素，监视网络状态，使用响应措施调整系统，主要措施有**检测拥塞**，**报告拥塞**，**调整措施**

## 路由算法

### 静态路由

* 手动配置路由表
* 简单，开销小
* 不能及时适应网络变化
* 仅适合于小网络

### 动态路由

* 较好的适应网络变化
* 实现复杂，开销大
* 适合复杂网络

#### 距离-向量算法

* 每个节点定期发送字节的路由选择表（包含**每条路径目的地**，**路径的代价**，**下一跳**）给所有直接相邻的节点
* 节点根据其他节点发来的路由表更新自己的路由表
* 若网络中节点过多，路由选择信息的数量会变得非常庞大

* 具体步骤见**RIP协议**


#### 状态-链路算法

* 主动测试所有邻接节点状态
* 定期将链路状态广播给其他节点
* 特征
  * 在自治系统中，发送链路信息采用**洪泛法**（路由通过所有端口向相邻节点发送信息，相邻节点以同样方式转发）
  * 发送信息为本路由器的**链路状态**（相邻路由器及其度量值）
  * 当链路状态改变时，才发送信息

#### 层次路由

* 因特网将整个互联网划分成多个**自治系统**（包含多个局域网系统）
* 自治系统内部自行选择路由协议，称为**内部网关协议（IGP）**
* 自治系统间使用**外部网关协议（EGP）**通信
* 自治系统内路由选择：域内路由选择
* 自治系统间路由选择：域间路由选择
* OSPF协议还可以将自治系统进一步划分成更小的子系统，称为**区域**
* OSPF协议按层次将区域分为上层区域（骨干区域，使用0.0.0.0作为标识）和下层区域
* 骨干区域用来联通所有下层区域，骨干区域内的路由器称为骨干路由
* 各个**区域**间使用区域边界路由器进行通信，各个**自治系统**间使用自治系统边界路由器
* 存在骨干区域的自治系统，自治边界路由器位于骨干区域内

## IPV4协议

### 数据报格式

* 首部长度：20~60B，长度必须为4的倍数，不足的部分使用自动填充，默认为20B
* 字段：
  * 版本：4位，用于区分IP协议版本
  * 首部长度：4位，单位为4B，故最大可表示60B
  * 区分服务：1B
  * 总长度：2B，包括首部和数据部分，单位为1B
  * 标识：2B，计数器产生的字段，用于标识数据报
  * 标志：3位
    * 第一位：MF字段，标记该数据报是否为最后一个分组，MF=0，代表该数据报为最后一片
    * 第二位：DF字段，若DF=1，则该数据报不能进行分组，此时若长度超限，则丢弃该数据报
    * 第三位：无用
  * 片偏移：13位，代表分片后的数据报起始位置在原数据报的偏移值，单位为8B
  * 生存时间（TTL）：8位，数据报可通过的最大路由器数
  * 协议：8位，代表传输层使用的协议
  * 首部校验和：8位，仅校验首部
  * 源地址：4B
  * 目的地址：4B

### 地址分类

|            | A类地址 | B类地址 | C类地址 | D类地址  | E类地址 |
| ---------- | ------- | ------- | ------- | -------- | ------- |
| 起始位     | 0       | 10      | 110     | 1110     | 1111    |
| 网络号位数 | 8       | 16      | 24      | 多播地址 | 保留    |
| 主机号位数 | 24      | 16      | 8       | 多播地址 | 保留    |

#### 特殊地址

| 地址类型         | 网络号 | 主机号     | 作为源地址还是目的地址 | 功能                         |
| ---------------- | ------ | ---------- | ---------------------- | ---------------------------- |
| 网络地址         | 特定   | 全0        | 都不是                 | 标识一个网络                 |
| 直接广播地址     | 特定   | 全1        | 目的地址               | 广播该网络中的所有主机       |
| 受限广播地址     | 全1    | 全1        | 目的地址               | 广播当前网络的所有主机       |
| 0.0.0.0          | 全0    | 全0        | 源地址或默认目的地址   | 代表自己的IP或默认目的地址   |
| 网络中的特定主机 | 全0    | 特定       | 目的地址               | 本网络下的特定主机           |
| 环回地址         | 127    | 不全为0或1 | 源地址或目的地址       | 限制在本机范围（常用于测试） |

### NAT

#### 专用地址（仅用于内网通信）

* **10.**0.0.0~**10.**255.255.255（1个A类地址）
* **172.16.**0.0~**172.31.**255.255（16个B类地址）
* **192.168.0.**0~**192.168.255.**255（256个C类地址）

#### 功能

* 将内网地址映射成外网地址

### 子网划分

#### 原因

* 二级IP地址设计的不合理
* 地址空间利用率有时很低
* 每一个物理网络分配一个网络号可能会使路由表过于臃肿
* 二级IP地址不够灵活

#### 子网掩码

* 不是必须令**前若干位为1，剩下位为0**

#### 注意

* 子网号不能全0或全1，但由于CIDR的广泛使用，在使用CIDR划分时，支持全0或全1

### CIDR

* 使用网络前缀划分子网，IP地址又变为2级结构
* 使用最长匹配原则
* 将小的网络汇聚成大的超网

### ARP

* 网络层协议
* IP地址转为MAC地址
* ARP请求分组：广播（携带源主机IP地址和硬件地址，目的主机IP地址）
* ARP响应分组：单播
* ARP只能解析本网络内的物理地址，对于跨网络的物理地址，只能通过路由器进行代理转发

### RARP

* 将物理地址转化为IP
* 现已淘汰

### DHCP

* 应用层协议
* 动态分配IP地址
* 使用UDP协议
* 请求报文源地址：0.0.0.0，目的地址：255.255.255.255
* DHCP服务器分配的IP是临时的，分配时间称为租用期
* 步骤
  1. 客户机广播**DHCP发现消息**，寻找DHCP服务器
  2. 服务器收到**DHCP发现消息**后，广播**DHCP提供消息**，提供IP地址和相关配置
  3. 客户机收到**DHCP提供消息**后，若接受该IP和参数，广播**DHCP请求消息**，申请分配该IP
  4. 服务器收到**DHCP请求消息**后，广播**DHCP确认消息**分配IP

### ICMP协议

* 网络层协议
* 用于报告发送数据的主机相应错误信息
* 分类
  * ICMP差错报文
  * ICMP询问报文
* ICMP差错报文分类
  * 终点不可达
  * 源抑制：发生拥塞
  * 时间超过
  * 参数问题
  * 改变路由（重定向）
* ICMP询问报文分类
  * 有回送请求和回答报文
  * 时间戳请求和回答报文
  * 掩码地址请求和回答报文
  * 路由器询问和通告报文
* 不发送ICMP的情况
  * 对ICMP差错报文不再发送ICMP差错报文
  * 对第一个分片的后续所有分片
  * 对有组播地址的数据报
  * 对具有特殊地址的数据报（如0.0.0.0，127.0.0.1）
* 应用
  * ping：使用**有回送请求和回答报文**，测试主机联通性，该软件工作在应用层
  * tracert：追踪分组路径
* ICMP报文组成
  * 类型+代码+校验和：4B
  * 内容取决于ICMP报文类型：4B
  * IP数据报首部
  * IP数据报数据部分的前8B（带有TCP，UDP报文的端口号）

## IPV6

### 特点

* 更大的地址空间（128位）
* 扩展的地址层次结构
* 灵活的首部格式
* 改进的选项允许协议继续扩充
* 支持即插即用（自动配置）
* 支持资源的预分配
* 长度为8B的整数倍

### 基本首部长度

* 40B

### 首部格式

* 版本：4位
* 通信量类：8位，指定数据报类别和优先级
* 流标号：20位
* 有效载荷长度：16位，除基本首部外的所有字节数
* 下一个首部：8位，相当于IPV4的可选字段或协议字段
* 条数限制：8位
* 源地址：128位
* 目的地址：128位

### 地址类型

* 单播
* 组播（广播为组播的特例）
* 任播（交付于一组主机中的任意一个）

### 地址简写

* 以每16位作为一个位域
* 每个16位域的前导0可省略
* 对于连续0值域，可用一个**::**代替，该简写至多出现一次

### 协议过渡

* 双协议站
* 隧道技术

## 路由协议

### 路由信息协议（RIP）

* 类型：内部网关协议
* 协议层级：应用层
* 使用UDP（端口520）
* 规定
  * 每个路由器维护自身到其他每个目的网络的距离（这是**一组**距离，称为距离向量）
  * RIP中距离定义为**跳数**
  * RIP认为好的路由即条数最少的路由
  * RIP中跳数最多为15，距离为16时，定义为**不可达**
  * 每30s广播一次路由更新信息
  * RIP不支持带子网掩码的RIP广播，故每个网络子网掩码必须相同，RIP2支持变长子网掩码和CIDR
* 特点
  * 仅与相邻路由器交换信息
  * 交换信息为自己的路由表
  * 按规定时间交换信息（如30s）
* 算法（距离向量算法）步骤：
  1. 每个节点定期发送字节的路由选择表（包含**每条路径目的地**，**距离**，**下一跳**）给所有直接相邻的节点
  2. 节点收到来自节点X的路由表后，修改所有**下一跳**字段为X，**距离**字段+1
  3. 对每一项条目，执行如下操作
     1. 若目的网络不在自身路由表中：将该项目添至路由表中
     2. 若**下一跳**字段与路由表中的地址一样：用该项目替换原项目
     3. 若新项目距离小于原项目：用该项目替换原项目
  4. 若180s（默认时间）未收到相邻路由信息，则更新路由表，将该路由设置为不可达路由
  5. 返回
* 报文格式：
  * 首部：4B，1B命令，1B版本，2B填充0
  * 路由：每条20B，最多25条
* 优点：
  * 简单
  * 开销小
  * 收敛速度快
* 缺点：
  * 最大距离15限制了网络规模
  * 网络规模越大，路由表传输开销也越大
  * 网络出现故障时，会出现慢收敛现象

### 开放最短路径优先协议（OSPF）

* 类型：内部网关协议
* 协议层级：网络层
* 使用IP协议
* 特点
  * 路由器向自治系统内的所有路由器发送信息，使用**泛洪法**
  * 交换信息为本路由器和所有相邻节点的链路状态（说明本路由器与哪些路由器相连，以及该链路的度量）
  * 链路状态改变时才发送信息
  * 更新过程收敛速度快
  * 针对不同链路以不同方式计算距离度量
  * 负载均衡（相同代价路径上均匀分配流量）
  * 支持可变长子网划分和CIDR
  * 每个链路状态带有一个序号标识新旧程度
  * 以组播地址发送报文（替代过去的广播发送）
* 原理（链路状态算法）：
  * 路由器更新链路状态后，使用Dijkstra算法计算最短路径
  * 路由表中只存储下一跳
  * 将自治系统进一步划分成区域，路由器仅在自身区域内使用泛洪法传播信息
  * 各路由器存储全网络的链路状态（链路状态数据库的同步）
* 分组类型
  * 问侯分组：发现和维持邻站的可达性（一般每隔10s交换一次，若40s未收到回复，则认为该节点不可达）
  * 数据库描述分组：自己链路状态数据库的所有链路状态的摘要信息
  * 链路状态请求分组：向对方请求某些链路状态项目的详细信息
  * 链路状态更新分组：用泛洪法对全网更新链路状态
  * 链路状态确认分组：对链路更新的分组的确认

### 边界网关协议（BGP）

* 类型：外部网关协议
* 协议层级：应用层
* 使用TCP协议
* 尽力选择一条可达目的地的较好网络，原因如下：
  * 因特网规模过大，路由选择非常困难
  * 难以寻找最佳路由
  * 自治系统间的路由选择必须考虑相关策略
* 原理（路径-向量算法）
  * 每个自治系统选择**至少**一个路由器作为**BGP发言人**
  * 每个发言人与其他自治系统的发言人交换路由信息（先使用TCP建立连接，之后建立**BGP会话**，再利用**BGP会话**交换信息）
  * 各发言人交换完网络可达性信息后，就能找出到达各自治系统的较好路由了
  * 路由交换方式
    * 首次：整个路由表
    * 非首次：有变化的部分
* BGP报文类型
  * 打开报文：与相邻的BGP发言人建立关系
  * 更新报文：发送某一路由信息和列出要撤销的路由信息
  * 保活（Keep a live）报文：确认打开报文和周期性证实邻站关系
  * 通知（Notification）报文：发送检测到差错
* 特点
  * 节点数量级为自治系统的数量级
  * 每个自治系统的BGP发言人数目很少
  * 支持CIDR
  * 首次交换整个路由表，之后只交换更新的部分

## IP组播

* 仅用于UDP

### 组播地址

* 使用D类地址
* 只能用于目的地址
* 不提供可靠交付
* 不产生ICMP报文
* 非所有地址都可组播

### 分类

* 本局域网上的硬件组播
* 因特网范围内的组播

### 组播IP与MAC转换

* 取IP地址后23位，补上前导0，构成24位
* 前面再补上固定首部01-00-5e，则构成MAC地址

### IGMP

* 用于局域网的组播协议
* IGMP让本地局域网的组播路由器知道是否有主机参加或退出某个组播组
* 步骤
  * 新主机加入组播组时，向该组播组发送一个IGMP报文，组播路由器收到后，将组成员关系转发给其他组播路由器
  * 组播路由器周期性探询局域网内主机是否仍是组的成员，若在若干次探询后某一组无主机相应，则不再转发该组的成员关系给其他组播路由器
* 路由选择：找出以源主机位根节点的组播转发树，每个分组再每条链路上至转发一次。不同源点的同一组播组和不同组播组都对应一个不同的多播转发树

### 因特网组播路由算法

* 链路状态的路由选择
* 距离-向量的路由选择
* 协议无关的组播（PIM）



## 移动IP

### 实体

* 移动节点
* 本地代理：移动节点所属网络的代理
* 外部代理：再外部网络中转发移动节点的代理

### 技术

* 代理搜索：让节点知道自己在漫游
* 申请转交地址
* 登录：移动节点在外网进行的认证，注册，建立隧道的过程
* 隧道：本地代理和外部代理间临时建立的双向数据通道

### 过程

1. 本地网络中，使用传统的通信方式
2. 节点漫游到外地网络时，向本地代理注册转发地址（外部代理地址或动态配置的地址）
3. 本地代理接收注册后，构建一条隧道，将发给移动节点的数据转发给转发地址
4. 移动节点使用网络的路由器和代理进行通信
5. 移动节点来到另一外网时，向本地代理更新新的转发地址
6. 移动节点回到本地时，向本地代理注销转发地址，即回到原通信方式

## 路由器

### 组成

* 路由选择部分
  * 功能：更新和维护路由表
  * 核心：路由选择处理器
* 分组转发部分
  * 组成：
    * 输入端口
    * 交换结构
    * 输出端口
  * 交换方法
    * 通过存储器交换
    * 通过总线交换
    * 通过互联网络交换

### 转发表和路由表

* 转发表根据路由表构建
* 转发时路由器根据转发表选择下一跳
* 转发表!=路由表
* 在路由选择中，一般不对其区分

## 其他零散知识

* IPV4分组在目的端主机重组
* IPV6禁止中间路由器进行分配操作
* IPV6不使用头部校验来保证传输正确性
* IPV6首部固定长度

* IP数据报仅校验首部信息，不校验数据部分